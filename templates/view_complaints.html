{% extends "layout.html" %}

{% block title %}View Complaints - Hostel Management{% endblock %}
{% block page_title %}Complaints & Maintenance Requests{% endblock %}

{% block content %}
<div class="actions-bar">
    <a href="{{ url_for('complaints.add_complaint') }}" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add New Complaint</a>
</div>

<div class="search-filter-form mb-3 card p-3">
    <form method="GET" action="{{ url_for('complaints.view_complaints') }}" class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="filter_room_number" class="form-label">Room Number:</label>
            <input type="text" id="filter_room_number" name="filter_room_number" class="form-control form-control-sm" value="{{ request.args.get('filter_room_number', '') }}">
        </div>
        <div class="col-md-3">
            <label for="filter_status" class="form-label">Status:</label>
            <select id="filter_status" name="filter_status" class="form-select form-select-sm">
                <option value="">All Statuses</option>
                {% for status in complaint_statuses %}
                <option value="{{ status }}" {% if request.args.get('filter_status') == status %}selected{% endif %}>{{ status }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="filter_priority" class="form-label">Priority:</label>
            <select id="filter_priority" name="filter_priority" class="form-select form-select-sm">
                <option value="">All Priorities</option>
                {% for priority in complaint_priorities %}
                <option value="{{ priority }}" {% if request.args.get('filter_priority') == priority %}selected{% endif %}>{{ priority }}</option>
                {% endfor %}
            </select>        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-info btn-sm me-2" title="Apply Filters"><i class="fas fa-filter"></i> Apply</button>
            <a href="{{ url_for('complaints.view_complaints') }}" class="btn btn-secondary btn-sm" title="Clear Filters"><i class="fas fa-times"></i> Clear</a>
        </div>
    </form>
</div>

<div class="table-responsive">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Reported Date</th>
                <th>Reported By</th>
                <th>Room No.</th>
                <th>Description</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Resolved Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for complaint in complaints %}
            <tr>
                <td>{{ complaint.id }}</td>
                <td>{{ complaint.reported_date.strftime('%Y-%m-%d') if complaint.reported_date else 'N/A' }}</td>
                <td>
                    {% if complaint.student_name %}
                        <a href="{{ url_for('student.edit_student', student_id=complaint.student_id) }}">{{ complaint.student_name }}</a>
                    {% else %}
                        <span class="text-muted">Not specified</span>
                    {% endif %}
                </td>
                <td>
                    {% if complaint.room_number %}
                        <a href="{{ url_for('room.edit_room', room_id=complaint.room_id) }}">{{ complaint.room_number }}</a>
                    {% else %}
                        <span class="text-muted">Not assigned</span>
                    {% endif %}
                </td>
                <td class="complaint-description-cell">{{ complaint.description }}</td>
                <td><span class="badge bg-{{ complaint.priority.lower() if complaint.priority else 'secondary' }}">{{ complaint.priority }}</span></td>
                <td><span class="status-badge status-{{ complaint.status.lower().replace(' ', '-') }}">{{ complaint.status }}</span></td>
                <td>{{ complaint.resolved_date.strftime('%Y-%m-%d') if complaint.resolved_date else 'N/A' }}</td>
                <td class="table-actions">
                    <a href="{{ url_for('complaints.edit_complaint', complaint_id=complaint.id) }}" class="btn-action btn-edit" title="Edit"><i class="fas fa-edit"></i></a>
                    <form action="{{ url_for('complaints.delete_complaint', complaint_id=complaint.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this complaint?');">
                        <button type="submit" class="btn-action btn-delete" title="Delete"><i class="fas fa-trash-alt"></i></button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="text-center">No complaints found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
